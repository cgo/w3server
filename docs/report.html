<html>
<body bgcolor=white>
<h1>Report on CNS 2000 programming project (C WWW browser/server)</h1>
Note: This is the original report of the programming project at University
that this software emerged from. Note that the Tcl/Tk part is not included 
and that the link to its documentation also doesn't work. Please also note
that Liuben Tonev's email is not current, I'm afraid I do not have a current one.
<b>Even though I praise it below, I switched from emacs which I used years ago to
    <a href="http://www.vim.org">VIM</a> ;-)</b>
<h2>Group 18, Liuben Tonev and Christian Gosch</h2>
This report consists of two parts. The first is the one you are
looking at now, the second one is the <a href="#code_doc">code documentation</a> and
how-to-use manual (quick start and how to compile) in <code>server/doc/html</code> and
<code>client/doc/html</code> directories. <br>
For understanding the code, we recommend reading both parts. <br>
If you want, go on reading about the <a href="#browser">browser</a> or the <a href="#server">server</a> directly.

<h2>Getting it running quickly</h2>
<h3>Client / Browser</h3>
<ul>
 <li>Follow the compile instructions in the <a href="#code_doc">code documentation</a></li>
 <li>Go to the respective <code>browser</code> subdirectory and start <code>browser.tcl</code></li>
</ul>

<h3>Server</h3>
 <li>Just follow the compile instructions in the <a href="#code_doc">code documentation</a></li>
</h3>

<h2>Work contributions from each group member</h2>
Group members were Liuben Tonev and Christian
Gosch. <br>
<h3><a href="mailto:tonly002@students.unisa.edu.au">Liuben Tonev</a></h3>

<ul>
  <li>Tcl/Tk Browser and documentation</li>
  <li>Cache mechanism and documentation</li>
  <li>Mail frontend</li>
</ul>

<h3><a href="mailto:christian@goschs.de">Christian Gosch</a></h3>
<ul>
 <li>Client C program and documentation</li>
 <li>Server C program and documentation</li>
 <li>This file</li>
 <li>How-to-use manual</li>
</ul>

<h2><a name="code_doc">Code Documentation and User Manuals</a></h2>
<ul>
 <li><a href="tcl-browser/BrowserReport.htm">Tcl/Tk Browser</a></li>
 <li><a href="../basic/client/doc/html/index.html">Basic client</a></li>
 <li><a href="../standard/client/doc/html/index.html">Standard client</a></li> 
 <li><a href="../standard/server/doc/html/index.html">Standard server</a></li> 
 <li><a href="../advanced/client/doc/html/index.html">Advanced client</a></li> 
 <li><a href="../advanced/server/doc/html/index.html">Advanced
 server</a></li> 
 <li><a href="../COPYING">Copying policy</a></li>
</ul>

<h2>Used Software</h2>
 <ol>
  <li>Operating systems: <a href="http://www.linux.org">Linux</a>
      2.2.13 and Solaris <br>
      The C part of the software was written entirely under Linux.</li>
  <li><a href="http://www.gnu.org">GNU</a> C compiler (gcc and egcs-2.91.66)</li>
  <li><a href="http://www.gnu.org">GNU</a> make 3.77</li>
  <li><a href="http://www.gnu.org">GNU</a> autoconf 2.13 / autoheader</li>
  <li>flex 2.5.4 lexical analyser generator</li>
  <li>Doxygen 0.49-991003 by <a href="mailto:dimitri@stack.nl">Dimitri van
      Heesch</a></li>
  <li><a href="http://www.gnu.org">GNU</a> Emacs 20.4.1 (there can be
      only one)</li>
  <li>Tcl/Tk 8.2</li>
 </ol>

<h2><a name=browser>Browser</a></h2>

<IMG SRC="browserdiag.png"  WIDTH="519" HEIGHT="213" ALT="Browser diagram" BORDER="0"> <br>

The browser consists of two parts: The GUI written in Tcl/Tk and the
actual client program written in C. 
The GUI takes commands from the user and uses the client program to
retrieve html files from the URI given by the user.
The advanced version downloads all images referenced in the html file
and corrects the downloaded html file, in the first version using the 'correct' program.
Correct is basically a lexical analyser generated by flex. <br>
Correct is no longer used, this work is now done by the image analyser
in client/src/img.lex. <br>

In the following description, all functions can be looked up in the
code documentation in <code>doc/html</code>.

<h2><a href="tcl-browser/BrowserReport.htm">Tcl browser documentation and user manual</a></h2>

<h3>The client program</h3>
<h4>Basic version</h4>
The main function (main.c) reads the command line parameters and hands
them over to <code>w3ClientDocToFile()</code>. This function takes the
URI, a filename of the file to write the received data to, and a port
number (for details, refer to the code documentation in
<code>doc/html</code>).
<code>w3ClientDocToFile()</code> uses <code>w3ParseURI()</code> to get
a <code>w3URI</code> structure out of the URI string.
Then, <code>w3ClientGetDocument()</code> is used to retrieve the
document from the server. There are facilities to retrieve documents
multi-threaded, but, since the GUI calls a client program for any
requested document, these facilities are not used.
<code>w3ClientGetDocument()</code> uses the lower level functions
<code>w3SendData()</code> and <code>w3ReceiveData()</code> to request
and receive the document.
The connection is established using <code>w3ClientConnect()</code> and
deleted by <code>w3ClientDisconnect()</code>.
These lower level functions use the known C socket interface to the network.

<h4>Standard version</h4>
Changes were made only to the Tcl code.

<h4>Advanced version</h4>
The main change to the previous version is the handling of downloaded
files.
A page is not simply stored but also analysed to find image tags and
automatically download the images. The images are stored in a simple cache
structure. <br>
Directly downloaded files are stored in a cache directory (standard is
<code>cache</code>) and image files subsequently downloaded are stored
in subdirectories of <code>cache</code> which resemble the URI path of
the images. <br>
For example, <code>www.animals.org/dog/cat/mouse.html</code> is stored
in the given destination file (still part of the command line to
<code>client</code>) AND in
the cache subdirectory (which is specified in <code>client/src/w3clientconfig.h</code>). The downloaded file is scanned for image tags and the
corresponding images are downloaded and stored in the cache directory, in this example that could be <br>
<code>cache/www.animals.org/pictures/dog.gif </code> <br>
The directly downloaded files are stored flatly in cache/, e.g. as <br>
cache/www.animals.org_index.html <br>
The slashes are replaced by underscores. This CAN lead to name clashes but that is neglected for this program. In a release version,
another mechanism would have to be used; since this program is free
and works fine for me, I am happy with it. It is, however, easy to
change this behaviour when needed.<br>
This behaviour <STRONG>can be switched off</STRONG> by defining or
undefining <code>W3CLIENT_CREATE_CACHE</code>. If this variable is
undefined, only the downloaded images are stored in the way described
above. <br>
All this caching is done by <code>w3ClientDocToFile()</code> and the
related functions in <code>w3client.c</code>. <br>


<h4>Handling of HREF Tags in Downloaded HTML Documents in the Advanced
Version</h4>
The file is scanned for HREF tags and relative tags (like <code>href="otherfile.html"...</code>)
are replaced by absolute ones (like
<code>href="http://www.server.com/otherfile.html"...</code>). <br>
This is done to enable the user interface to make use of hyperlinks
which would otherwise be handles as local files.

<h4>The Analyser Code</h4>
The replacement of <code>img</code> and <code>href</code> tags is done
by an analyser which is created using <code>flex</code>. The source
code for flex can be found in <a
href="../advanced/client/src/img.lex">advanced/client/src/img.lex</a>.
<br>
In case it becomes necessary to change and rebuild the analyser, call
<br>
<code>flex -i img.lex</code> <br>
in the source directory. Of course you need the flex package to do this.


<h4>Sending Mails With <code>client</code></h4>
The advanced version of <code>client</code> is capable of sending
emails through an SMTP server. The code added for sending emails can
be found in <code>w3smtp.c</code>. <br>
The functions used to send mails are <code>w3SendMail()</code> and
<code>w3SendMailFile()</code>. The latter is used by the
<code>main()</code> client function to send mails.
<code>w3SendMailFile()</code> reads the needed data from a file and
calls <code>w3SendMail()</code>. <br>
The file given to the <code>client</code> program MUST have the
following structure: <br>
<hr><br>
First line: Recipient <br>
Second line: Sender <br>
Third line: mailer <br>
Fourth line: port number on which the mailer accepts connections <br>
The following lines contain the mail body, including ALL headers the sender wants to be sent (including sender and recipient
  headers). <br>
<hr><br>
This description can also be found in the code documentation for <code>w3SendMailFile()</code>.


<h2><a name="server">Server</a></h2>
<img src="serverdiag.png" alt="Server diagram"> <br>
<h3>Standard version</h3>
The server operates in multiple threads. The current version runs six
accepting threads in parallel, but this number can be changed at will
in the file <code>w3server.c</code> in function
<code>w3StartServer()</code> simply by changing the loop which starts
the threads (how to do this is obvious and needs no further
description). <br>
The <code>main ()</code> function calls the function
<code>w3StartServer()</code> which sets up everything to run the
server: <br>
<ul>
 <li>Set up 5 threads (plus the main thread) to accept incoming
 connections</li>
 <li>Every thread waits for a connection, starts a new thread as soon
 as a connection was accepted and then receives the request</li>
 <li>Every thread disconnects after the response was sent</li>
</ul>
All send and receive operations are wrapped by convenience functions,
which are explained in the <a href="#code_doc">code documentation</a>.



<h3>Advanced version</h3>
Standard and advanced version are the same program except for the
ability of the advanced version to execute files on the server machine. No changes were
needed in order to make the server to send any file requested (other
than <code>.html</code>). <br>

<h4>Executing binaries on the serverside</h4>
Thinking of CGI, the implementation of something similar was started
(but not yet finished). <br>
The server is capable of executing files in the binary directory,
which is defined in <code>w3server.h</code> as
<code>HTDOC_BIN_BASE</code>. When a file in this directory is
requested, it is instead executed and the standard output of that
executable (be it a binary or a shell script) is sent to the
client. <br>
If you set the default HTDOCS directory to the htdocs directory delivered with this package, and you are getting this documentation from our server, <a href="/bin/test">this</a> should give an example. <br>
Program arguments are yet to be implemented (using the
"prgname?arg1=..." syntax). All the server can do with this feature
yet is executing files without arguments. <br>
See also the code documentation for the advanced server, function <code>w3ServerSendFile()</code>.

<h3>Error handling</h3>
The server handles errors in client requests by responding with an
error page. The code for the creation of the error pages can be found
in <code>w3html.c</code> (<code>w3HTMLGenerateError()</code>). <br>
An example error page can be seen <a href=errorpage.html>here</a>.

<h1>Problems encountered (C-part and Tcl/Tk-part)</h1>
<ul>
 <li>The test platform (logic.levels.unisa.edu.au) was often at the limit of its resources (meaning the memory was exhausted) and made the browser as well as the server crash.</li>
 <li><a href="tcl-browser/BrowserReport.htm#bugs">More bug reports (Tcl code)</a></li>
</ul>

</body>
</html>











